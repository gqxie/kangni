<!DOCTYPE html>
<html>
{% load static %}
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>首页</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">

    {#    <link href="https://unpkg.com/video.js/dist/video-js.min.css" rel="stylesheet">#}
    {#    <link rel="stylesheet" href="https://unpkg.com/browse/vue-video-player@5.0.2/src/custom-theme.css">#}


    <style>
        body {
            margin: 10px;
        }

        .el-footer {
            text-align: center;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .el-header {
            margin-left: 20px;
            padding: 10px 0 0 0;
        }

        .el-drawer__body {
            margin-left: 20px;
        }

        .el-divider--horizontal {
            margin: 0 0;
        }

        .el-main {
            padding-top: 0;
            overflow: hidden;
        }

        .el-aside {
            height: 500px;
        }

        .h5video {
            width: 576px;
            height: 320px;
            border: 1px solid black;
            background-color: #000000;
        }

        .h5video1 {
            width: 100%;
            height: 100%;
            border: 1px solid black;
            background-color: #000000;
        }

        .h5videodiv {
            display: inline-block;
            position: relative;
        }

        .h5videodiv1 {
            width: 100%;
            height: 100%;
            position: relative;
            background-color: #000000;
        }

        .playpause {
            background-image: url({% static 'h5stream/img/media_play_pause_resume.png' %});
            background-repeat: no-repeat;
            width: 25%;
            height: 25%;
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            margin: auto;
            background-size: contain;
            background-position: center;
        }

    </style>
</head>
<body>
<div id="app">
    <template>
        <el-container>
            <el-header>
                <el-select v-model="selectorValue" placeholder="请选择摄像头">
                    <el-option
                            v-for="item in selectorOptions"
                            :key="item.value"
                            :label="item.label"
                            :value="item.value">
                    </el-option>
                </el-select>
                <el-button type="primary" @click="handleEventList">事件查看</el-button>
            </el-header>
            <el-main>
                {#                <el-table#}
                {#                        stripe#}
                {#                        size="small"#}
                {#                        :data="tableData"#}
                {#                        style="width: 100%">#}
                {#                    <el-table-column#}
                {#                            type="selection"#}
                {#                            width="55">#}
                {#                    </el-table-column>#}
                {#                    <el-table-column#}
                {#                            type="index"#}
                {#                            width="50"#}
                {#                            label="序号">#}
                {#                    </el-table-column>#}
                {#                    <el-table-column#}
                {#                            prop="id"#}
                {#                            label="摄像头id"#}
                {#                            v-if="false">#}
                {#                    </el-table-column>#}
                {#                    <el-table-column#}
                {#                            prop="cameraName"#}
                {#                            label="名称"#}
                {#                            width="180">#}
                {#                    </el-table-column>#}
                {#                    <el-table-column#}
                {#                            prop="ip"#}
                {#                            label="ip地址"#}
                {#                            width="180">#}
                {#                    </el-table-column>#}
                {#                    <el-table-column#}
                {#                            prop="cameraUseType"#}
                {#                            label="用途"#}
                {#                            width="180">#}
                {#                    </el-table-column>#}
                {#                    <el-table-column#}
                {#                            prop="state"#}
                {#                            label="状态"#}
                {#                            width="120">#}
                {#                        <template slot-scope="scope">#}
                {#                            <el-tag#}
                {#                                    :type="scope.row.state === '在线' ? 'success' : 'danger'"#}
                {#                                    disable-transitions>{% templatetag openvariable %}#}
                {#                                scope.row.state {% templatetag closevariable %}</el-tag>#}
                {#                        </template>#}
                {#                    </el-table-column>#}
                {#                    <el-table-column label="操作">#}
                {#                        <template slot-scope="scope">#}
                {#                            <el-tooltip class="item" effect="dark" content="事件列表" placement="top">#}
                {#                                <i style="font-size: 20px;font-weight: 600 !important;padding: 0 5px !important;background-color: transparent;color: #1890ff;"#}
                {#                                   class="el-icon-date" @click="handleEventList(scope.$index, scope.row)"></i>#}
                {#                            </el-tooltip>#}
                {#                            <el-tooltip class="item" effect="dark" content="监控视频" placement="top">#}
                {#                                <i style="font-size: 20px;font-weight: 600 !important;padding: 0 5px !important;background-color: transparent;color: #1890ff;"#}
                {#                                   class="el-icon-video-camera" @click="showVideo(scope.$index, scope.row)"></i>#}
                {#                            </el-tooltip>#}
                {#                        </template>#}
                {#                    </el-table-column>#}
                {#                </el-table>#}
                <div class="h5videodiv">
                    <video class="h5video" id="h5sVideo1" autoplay webkit-playsinline playsinline></video>
                    <div class="playpause" id="playpause1"></div>
                </div>
                <div class="h5videodiv">
                    <video class="h5video" id="h5sVideo2" autoplay webkit-playsinline playsinline></video>
                    <div class="playpause" id="playpause2"></div>
                </div>
                <div class="h5videodiv">
                    <video class="h5video" id="h5sVideo3" autoplay webkit-playsinline playsinline></video>
                    <div class="playpause"></div>
                </div>
                <div class="h5videodiv">
                    <video class="h5video" id="h5sVideo4" autoplay webkit-playsinline playsinline></video>
                    <div class="playpause"></div>
                </div>

                <el-dialog :title="dialogTitle" :visible.sync="dialogTableVisible" @closed="dialogClosed">
                    <video
                            width="100%"
                            height="100%"
                            id="my-player"
                            class="video-js"
                            controls
                            muted
                            autoplay
                            loop="loop"
                            preload="auto"
                            poster="{% static 'h5ssample.png' %}"
                            data-setup='{}'>
                        <source src="{% static 'h5ssample.mp4' %}" type="video/mp4">
                        {#                        <source src="//vjs.zencdn.net/v/oceans.mp4" type="video/mp4">#}
                        {#                        <source src="//vjs.zencdn.net/v/oceans.webm" type="video/webm">#}
                        {#                        <source src="//vjs.zencdn.net/v/oceans.ogv" type="video/ogg">#}
                        {#                        <p class="vjs-no-js">#}
                        {#                            <a href="https://videojs.com/html5-video-support/" target="_blank">#}
                        {#                            </a>#}
                        {#                        </p>#}
                    </video>
                </el-dialog>

                <el-drawer
                        :title="drawerTitle"
                        :visible.sync="drawer"
                        direction="rtl"
                        size="60%">
                    <el-container>
                        <el-divider></el-divider>
                        <el-header>
                            <div class="block" style="margin-top: 10px;">
                                <el-date-picker
                                        v-model="eventDate"
                                        type="daterange"
                                        align="right"
                                        unlink-panels
                                        range-separator="至"
                                        start-placeholder="开始日期"
                                        end-placeholder="结束日期"
                                        :picker-options="pickerOptions"
                                        value-format="yyyy-MM-dd">
                                </el-date-picker>
                                <el-button type="primary" icon="el-icon-search" size="medium" @click="searchEvent">
                                    搜索
                                </el-button>
                            </div>
                        </el-header>
                        <el-divider></el-divider>
                        <el-container>
                            <el-aside width="240px">
                                <el-tree :data="treeData" :props="defaultProps" @node-click="handleNodeClick"
                                         accordion icon-class="el-icon-time"></el-tree>
                            </el-aside>
                            <el-main>
                                <el-image
                                        style="width: 100%; height: 50%;overflow-y:visible"
                                        :src="url"
                                        fit="contain"
                                        :preview-src-list="srcList">
                                    <div slot="error" class="image-slot">
                                        <i class="el-icon-picture-outline"></i>
                                    </div>
                                </el-image>
                            </el-main>
                        </el-container>
                        <el-divider></el-divider>
                    </el-container>
                </el-drawer>
            </el-main>

            <el-footer>
                {#                <el-pagination#}
                {#                        background#}
                {#                        @size-change="handleSizeChange"#}
                {#                        @current-change="handleCurrentChange"#}
                {#                        :current-page.sync="currentPage"#}
                {#                        :page-sizes="[10, 20, 50, 100]"#}
                {#                        :page-size="currentSize"#}
                {#                        layout="total, prev, pager, next, sizes"#}
                {#                        :total="totalNum">#}
                {#                </el-pagination>#}
            </el-footer>

        </el-container>
    </template>
</div>
<!-- import Vue before Element -->
<script src="https://unpkg.com/vue/dist/vue.js"></script>
<!-- import JavaScript -->
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://unpkg.com/axios@0.19.0/dist/axios.min.js"></script>

<script src="{% static 'h5stream/js/jquery-3.1.1.js' %}"></script>
<script src="{% static 'h5stream/js/bootstrap.js' %}"></script>
<script src="{% static 'h5stream/js/adapter.js' %}"></script>
<script src="{% static 'h5stream/js/platform.js' %}"></script>
<script src="{% static 'h5stream/js/h5splayer.js' %}"></script>
<script src="{% static 'h5stream/js/h5splayerhelper.js' %}"></script>

{#<script src="https://unpkg.com/browse/video.js@7.6.0/dist/video.min.js"></script>#}
{#<script src="https://unpkg.com/browse/vue-video-player@5.0.2/dist/vue-video-player.js"></script>#}
<script>
    new Vue({
        el: '#app',
        data() {
            return {
                tableData: [],
                currentPage: 1,
                currentSize: 10,
                totalNum: 0,
                drawer: false,
                activeName: 'second',
                drawerTitle: '',

                treeData: [],
                defaultProps: {
                    children: 'children',
                    label: 'label'
                },
                url: '',

                pickerOptions: {
                    shortcuts: [{
                        text: '最近一周',
                        onClick(picker) {
                            const end = new Date();
                            const start = new Date();
                            start.setTime(start.getTime() - 3600 * 1000 * 24 * 7);
                            picker.$emit('pick', [start, end]);
                        }
                    }, {
                        text: '最近一个月',
                        onClick(picker) {
                            const end = new Date();
                            const start = new Date();
                            start.setTime(start.getTime() - 3600 * 1000 * 24 * 30);
                            picker.$emit('pick', [start, end]);
                        }
                    }, {
                        text: '最近三个月',
                        onClick(picker) {
                            const end = new Date();
                            const start = new Date();
                            start.setTime(start.getTime() - 3600 * 1000 * 24 * 90);
                            picker.$emit('pick', [start, end]);
                        }
                    }]
                },
                eventDate: '',
                srcList: [],
                currentCamera: '',

                dialogTableVisible: false,
                dialogTitle: '',

                selectorOptions: [{
                    value: '1',
                    label: '摄像头一'
                }, {
                    value: '2',
                    label: '摄像头二'
                }, {
                    value: '3',
                    label: '摄像头三'
                }, {
                    value: '4',
                    label: '摄像头四'
                }],
                selectorValue: ''

            };
        },
        created() {
            const _this = this;
            _this.getAllCamera(_this.currentPage, _this.currentSize);
        },
        mounted() {
            if (H5siOS() === true
                || H5sSafariBrowser() === true) {
                $('#h5sVideo1').prop("controls", true);
                $('#h5sVideo2').prop("controls", true);
                $('#h5sVideo3').prop("controls", true);
                $('#h5sVideo4').prop("controls", true);
            }
            let conf1 = {
                videoid: 'h5sVideo1',
                protocol: window.location.protocol, //'http:' or 'https:'
                host: window.location.host, //'localhost:8080'
                rootpath: '/', // '/' or window.location.pathname
                token: 'token1',
                hlsver: 'v1', //v1 is for ts, v2 is for fmp4
                session: 'c1782caf-b670-42d8-ba90-2244d0b0ee83' //session got from login
            };

            let conf2 = {
                videoid: 'h5sVideo2',
                //videodom: h5svideodom2,
                protocol: window.location.protocol, //'http:' or 'https:'
                host: window.location.host, //'localhost:8080'
                rootpath: '/', // '/' or window.location.pathname
                token: 'token1',
                hlsver: 'v1', //v1 is for ts, v2 is for fmp4
                session: 'c1782caf-b670-42d8-ba90-2244d0b0ee83' //session got from login
            };

            //If there has no videoid, the videodom can be the videodom. if there has videoid, just use the videoid
            let h5svideodom3 = document.getElementById('h5sVideo3');
            let conf3 = {
                //videoid:'h5sVideo3',
                videodom: h5svideodom3,
                protocol: 'http:', //'http:' or 'https:'
                host: 'localhost:8080', //'localhost:8080'
                rootpath: '/', // '/' or window.location.pathname
                token: 'token2',
                hlsver: 'v1', //v1 is for ts, v2 is for fmp4
                session: 'c1782caf-b670-42d8-ba90-2244d0b0ee83' //session got from login
            };
            let conf4 = {
                videoid: 'h5sVideo4',
                protocol: 'http:', //'http:' or 'https:'
                host: 'localhost:8080', //'localhost:8080'
                rootpath: '/', // '/' or window.location.pathname
                token: 'token3',
                hlsver: 'v1', //v1 is for ts, v2 is for fmp4
                session: 'c1782caf-b670-42d8-ba90-2244d0b0ee83' //session got from login
            };
            let v1 = H5sPlayerCreate(conf1);
            let v2 = new H5sPlayerRTC(conf2);
            let v3 = H5sPlayerCreate(conf3);
            let v4 = H5sPlayerCreate(conf4);

            $('#h5sVideo1').parent().click(function () {
                if ($(this).children(".h5video").get(0).paused) {
                    if (v1 != null) {
                        v1.disconnect();
                        delete v1;
                        v1 = null;
                    }
                    v1 = H5sPlayerCreate(conf1);
                    v1.connect();
                    $(this).children(".playpause").fadeOut();
                } else {
                    v1.disconnect();
                    delete v1;
                    v1 = null;
                    $(this).children(".h5video").get(0).pause();
                    $(this).children(".playpause").fadeIn();
                }
            });

            $('#h5sVideo2').parent().click(function () {
                if ($(this).children(".h5video").get(0).paused) {
                    if (v2 != null) {
                        v2.disconnect();
                        delete v2;
                        v2 = null;
                    }
                    v2 = new H5sPlayerRTC(conf2);
                    v2.connect();
                    $(this).children(".playpause").fadeOut();
                } else {
                    v2.disconnect();
                    delete v2;
                    v2 = null;
                    $(this).children(".h5video").get(0).pause();
                    $(this).children(".playpause").fadeIn();
                }
            });

            $('#h5sVideo3').parent().click(function () {
                if ($(this).children(".h5video").get(0).paused) {
                    if (v3 != null) {
                        v3.disconnect();
                        delete v3;
                        v3 = null;
                    }

                    v3 = H5sPlayerCreate(conf3);
                    v3.connect();
                    $(this).children(".playpause").fadeOut();
                } else {
                    v3.disconnect();
                    delete v3;
                    v3 = null;
                    $(this).children(".h5video").get(0).pause();
                    $(this).children(".playpause").fadeIn();
                }
            });

            $('#h5sVideo4').parent().click(function () {
                if ($(this).children(".h5video").get(0).paused) {
                    if (v4 != null) {
                        v4.disconnect();
                        delete v4;
                        v4 = null;
                    }
                    v4 = H5sPlayerCreate(conf4);
                    v4.connect();
                    $(this).children(".playpause").fadeOut();
                } else {
                    v4.disconnect();
                    delete v4;
                    v4 = null;
                    $(this).children(".h5video").get(0).pause();
                    $(this).children(".playpause").fadeIn();
                }
            });
        },
        methods: {
            handleSizeChange(val) {
                const _this = this;
                _this.currentSize = val;
                _this.currentPage = 1;
                _this.getAllCamera(_this.currentPage, _this.currentSize);
            },
            handleCurrentChange(val) {
                const _this = this;
                _this.currentPage = val;
                _this.getAllCamera(_this.currentPage, _this.currentSize);
            },
            getAllCamera(page, size) {
                const _this = this;
                axios({
                    method: 'get',
                    url: 'getAllCamera' + '?page=' + page + '&size=' + size
                }).then(function (resp) {
                    _this.tableData = resp.data.data;
                    _this.totalNum = resp.data.count;
                }).catch(resp => {
                    _this.$message.error('请求失败！')
                });
            },
            handleDetail(index, row) {
                const _this = this;
                _this.drawerTitle = '详情：' + row.cameraName;
                _this.drawer = true;
            },
            handleEventList() {
                const _this = this;
                let obj = {};
                obj = _this.selectorOptions.find((item) => {
                    return item.value === _this.selectorValue;
                });
                let labelName = '';
                labelName = obj.label;
                _this.drawerTitle = '违章记录：' + labelName;
                _this.drawer = true;
                _this.getAllEventByCamera(_this.selectorValue, '', '');
            },
            getAllEventByCamera(cameraId, startDate, endDate) {
                const _this = this;
                _this.currentCamera = cameraId;
                axios({
                    method: 'get',
                    url: 'getAllEventByCamera' + '?id=' + cameraId + '&start=' + startDate + '&end=' + endDate
                }).then(function (resp) {
                    _this.treeData = resp.data.data;
                    _this.url = resp.data.url;
                    _this.srcList = resp.data.srcList;
                }).catch(resp => {
                    _this.$message.error('请求失败！')
                });
            },
            handleClick(tab, event) {
                console.log(tab, event);
            },
            handleNodeClick(data) {
                const _this = this;
                if (data.url != undefined) {
                    _this.url = data.url;

                    let srcListLength = _this.srcList.length;
                    let i = srcListLength;
                    let index = 0;
                    while (i--) {
                        if (_this.srcList[i] === _this.url) {
                            index = i
                        }
                    }
                    let preArray = _this.srcList.slice(0, index);
                    let suffixArray = _this.srcList.slice(index, srcListLength);
                    _this.srcList = suffixArray.concat(preArray);
                }
            },
            searchEvent() {
                const _this = this;
                startDate = '';
                endDate = '';
                if (_this.eventDate !== '' && _this.eventDate !== "undefined" && _this.eventDate != null) {
                    startDate = _this.eventDate[0];
                    endDate = _this.eventDate[1];
                }
                _this.getAllEventByCamera(_this.currentCamera, startDate, endDate)
            },

            showVideo(index, row) {
                const _this = this;
                _this.dialogTitle = row.cameraName + '监控画面';
                _this.dialogTableVisible = true;
                var player = document.getElementById("my-player");
                if (null != player) {
                    player.load();
                }
            },

            dialogClosed() {
                var player = document.getElementById("my-player");
                player.pause();
            }

        }
    });
</script>
</body>
</html>
